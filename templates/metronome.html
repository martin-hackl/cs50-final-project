{% extends "layout.html" %}

{% block title %}
    Metronome
{% endblock %}

{% block main %}
    <div>
        <input autocomplete="off" autofocus name="bpm" id="bpm" min="40" max="250" type="number" value="60">
        <label for="bpm">BPM</label>
    </div>
    

    <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
            <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" value="2">
            <label class="btn btn-outline-primary" for="btnradio1">2/4</label>
        
            <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off" value="3">
            <label class="btn btn-outline-primary" for="btnradio2">3/4</label>
        
            <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off" value ="4" checked>
            <label class="btn btn-outline-primary" for="btnradio3">4/4</label>
      </div>

      <div>
        <input type="range" id="volume" name="volume"
               min="0" max="50" value="25">
        <label for="volume">Volume</label>
      </div>

      <div class="d-grid gap-2 col-6 mx-auto">
        <button class="btn btn-primary" id="playbutton" type="button">Play</button>
      </div>

      <script>
        let isPlaying = false;
        let tempo = 60;
        let measure = 4;
        let pulseHZFirst = 880;
        let pulseHZ = 440;
        const audioContext = new AudioContext();

        //Eventlistener for BPM Changes
        document.getElementById("bpm").addEventListener(
            "change",
            (ev) => {
                tempo = document.getElementById("bpm").value;
                console.log(tempo)
            },
            false
        )
        
        //Eventlistener for Radiobuttons Measure changes
        let radioBtns = document.querySelectorAll("input[name='btnradio']");
        
        let findSelected = () => {
            measure = document.querySelector("input[name='btnradio']:checked").value;
            console.log(measure)
        }
        
        radioBtns.forEach(radioBtn => {
            radioBtn.addEventListener(
                "change",
                findSelected
            );
        });

        //create gain control node and connect it to audio destination
        //get user input from volume control and pass it to gain
        const primaryGainControl = audioContext.createGain()
        let userVolume = document.getElementById("volume").value * 0.01;
        
        //setting initial gain value
        primaryGainControl.gain.setValueAtTime(userVolume, 0);

        //update gain on user input
        document.getElementById("volume").addEventListener(
            "input",
            (ev) => {
                //console.log(ev)
                let newVolume = document.getElementById("volume").value;
                userVolume = newVolume * 0.01;
                primaryGainControl.gain.setValueAtTime(userVolume, 0);
            },
            false
        ); 

        //onclick event for playbutton switch true/false

        document.getElementById("playbutton").addEventListener(
            "click",
            (ev) => {
                if(isPlaying == false){
                    isPlaying = true;
                    while(isPlaying == true){
                        const firstOscillator = audioContext.createOscillator()
                        firstOscillator.frequency.setValueAtTime(800, 0)
                        firstOscillator.connect(primaryGainControl)
                        firstOscillator.start(audioContext.currentTime)
                        firstOscillator.stop(audioContext.currentTime + 0.08)
                        
                    }
                }

                else if(isPlaying == true){
                    isPlaying = false;
                }

                console.log(isPlaying);
            },
            false
        )
        
        
        //audio output
        primaryGainControl.connect(audioContext.destination)

        //create a button which triggers an oscillator
        const firstClickButton = document.createElement('button')
        firstClickButton.innerText = "First Click"
        firstClickButton.addEventListener("click", () => {
            const clickOscillator = audioContext.createOscillator()

            clickOscillator.frequency.setValueAtTime(pulseHZFirst, 0)
            clickOscillator.connect(primaryGainControl)
            clickOscillator.start()
            clickOscillator.stop(audioContext.currentTime + 0.08)
        })

        document.body.appendChild(firstClickButton)

        //create a second button which triggers an oscillator
        const clickButton = document.createElement('button')
        clickButton.innerText = "Click"
        clickButton.addEventListener("click", () => {
            const clickOscillator = audioContext.createOscillator()

            clickOscillator.frequency.setValueAtTime(pulseHZ, 0)
            clickOscillator.connect(primaryGainControl)
            clickOscillator.start()
            clickOscillator.stop(audioContext.currentTime + 0.08)
        })

        document.body.appendChild(clickButton)

      </script>

{% endblock %}